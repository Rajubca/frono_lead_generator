<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frono BuddyAI Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- Containers --- */
        #frono-widget-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 9999;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* --- Launcher Button --- */
        #frono-launcher {
            width: 60px; height: 60px; background: #000; color: #fff;
            border-radius: 50%; border: none; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        #frono-launcher:hover { transform: scale(1.05); }

        /* --- Chat Window --- */
        #frono-chat {
            position: absolute; bottom: 80px; right: 0;
            width: 350px; height: 500px; background: #fff;
            border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; overflow: hidden;
            opacity: 1; transform: translateY(0); transition: all 0.3s ease;
        }
        #frono-chat.hidden { opacity: 0; pointer-events: none; transform: translateY(20px); }

        /* --- Header --- */
        #chat-header {
            background: #000; color: #fff; padding: 16px;
            font-weight: 600; display: flex; justify-content: space-between; align-items: center;
        }
        .header-title-group { display: flex; align-items: center; gap: 8px; flex: 1; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; transition: background 0.3s; }
        .status-dot.online { background-color: #2ecc71; }
        .status-dot.offline { background-color: #e74c3c; }
        #reconnect-btn { background: transparent; border: 1px solid rgba(255,255,255,0.4); color: #fff; font-size: 11px; padding: 2px 8px; border-radius: 12px; cursor: pointer; margin-left: auto; margin-right: 8px; }
        #reconnect-btn.hidden { display: none; }
        .close-btn { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; line-height: 1; }

        /* --- Body --- */
        #chat-body { flex: 1; overflow-y: auto; padding: 16px; background: #f4f4f4; display: flex; flex-direction: column; gap: 10px; }

        /* --- Messages --- */
        .message { max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .message.user { align-self: flex-end; background: #000; color: #fff; border-bottom-right-radius: 4px; }
        .message.bot { align-self: flex-start; background: #fff; color: #333; border: 1px solid #e0e0e0; border-bottom-left-radius: 4px; }
        .message.bot p { margin: 0 0 6px 0; }
        .message.bot p:last-child { margin-bottom: 0; }
        .msg-time { display: block; font-size: 10px; margin-top: 6px; opacity: 0.7; text-align: right; }

        /* --- Product Cards --- */
        .product-card {
            background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 12px;
            margin-top: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex; gap: 12px; align-items: center; transition: transform 0.2s;
        }
        .product-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .product-image { width: 50px; height: 50px; border-radius: 8px; background: #f0f0f0; object-fit: cover; }
        .product-info { flex: 1; }
        .product-name { font-weight: 600; font-size: 13px; margin-bottom: 4px; line-height: 1.2; }
        .product-meta { font-size: 12px; color: #666; display: flex; justify-content: space-between; align-items: center; }
        .product-price { color: #000; font-weight: 700; }

        .product-select-btn {
            background: #000; color: #fff; border: none; padding: 4px 10px;
            border-radius: 12px; font-size: 11px; cursor: pointer; font-weight: 500;
        }
        .product-select-btn:hover { background: #333; }

        /* --- Option Buttons --- */
        .options-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .option-btn {
            background: #fff; border: 1px solid #000; color: #000;
            padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 500;
            cursor: pointer; transition: all 0.2s;
        }
        .option-btn:hover { background: #000; color: #fff; }

        /* --- Input Area --- */
        #chat-input-area { padding: 12px; background: #fff; border-top: 1px solid #eee; display: flex; align-items: center; gap: 8px; }
        #chat-text { flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; font-size: 14px; transition: border-color 0.2s; }
        #chat-text:focus { border-color: #000; }
        #chat-text:disabled { background-color: #f9f9f9; cursor: not-allowed; }
        #send-btn { background: #000; color: #fff; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #send-btn:disabled { background: #ccc; cursor: not-allowed; }

        #typing-indicator { padding: 8px 16px; background: #fff; align-self: flex-start; border-radius: 18px; border: 1px solid #e0e0e0; margin-left: 16px; margin-bottom: 10px; display: flex; gap: 4px; width: fit-content; }
        #typing-indicator.hidden { display: none; }
        #typing-indicator span { display: block; width: 6px; height: 6px; background: #888; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        #typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        #typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body>

<div id="frono-widget-container">
  <button id="frono-launcher" onclick="toggleChat()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
  </button>

  <div id="frono-chat" class="hidden">
    <div id="chat-header">
      <div class="header-title-group">
        <span id="connection-status" class="status-dot offline" title="Disconnected"></span>
        <span>Frono BuddyAI</span>
        <button id="reconnect-btn" class="hidden" onclick="manualReconnect()">Reconnect ↻</button>
      </div>
      <button class="close-btn" onclick="toggleChat()">×</button>
    </div>

    <div id="chat-body"></div>
    <div id="typing-indicator" class="hidden"><span>•</span><span>•</span><span>•</span></div>

    <div id="chat-input-area">
      <input type="text" id="chat-text" placeholder="Type a message..." autocomplete="off" />
      <button id="send-btn" onclick="handleUserSend()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
      </button>
    </div>
  </div>
</div>

<script>
  /* ================= CONFIG ================= */
  const API_BASE = "http://127.0.0.1:8000"; 
  const CHAT_STREAM_POST = `${API_BASE}/chat/stream`;
  const HEALTH_API = `${API_BASE}/health`;

  let eventSource = null;
  let currentBotMessageDiv = null;
  let requestStartTime = 0;
  const SESSION_ID = "sess_" + Math.random().toString(36).substr(2, 9);

  /* ================= INIT ================= */
  document.addEventListener("DOMContentLoaded", function() {
      // 1. Initial Greeting
      appendMessage("Welcome to Frono.uk! How can I help you today?", "bot");

      // 2. Initial Options (Search/Buy vs Support)
      renderRichContent([
          { type: "option", label: "Search / Buy Products", value: "Show me popular products" },
          { type: "option", label: "Customer Support", value: "I need customer support" }
      ]);

      setupEventSource();
      setInterval(checkConnection, 10000); 
  });

  /* ================= CORE LOGIC ================= */
  function setupEventSource() {
      if (eventSource) eventSource.close();
      eventSource = new EventSource(`${API_BASE}/chat/stream/events/${SESSION_ID}`);

      eventSource.onopen = () => updateStatus("online");
      eventSource.onerror = () => updateStatus("offline");

      eventSource.addEventListener("products", function(event) {
          try {
              const data = JSON.parse(event.data);
              renderRichContent(data);
          } catch(e) { console.error("Error parsing rich content:", e); }
      });

      eventSource.onmessage = function (event) {
          if (!currentBotMessageDiv) return;
          if (event.data === "END") return;
          
          currentBotMessageDiv._rawText = (currentBotMessageDiv._rawText || "") + event.data;
          try {
             currentBotMessageDiv.innerHTML = marked.parse(currentBotMessageDiv._rawText);
          } catch(e) {
             currentBotMessageDiv.textContent = currentBotMessageDiv._rawText;
          }
          scrollToBottom();
      };

      eventSource.addEventListener("end", function () {
          toggleInputState(false);
          currentBotMessageDiv = null;
      });
  }

  function renderRichContent(items) {
      if (!items || items.length === 0) return;
      const body = document.getElementById("chat-body");

      const isOption = items[0].type === "option";

      if (isOption) {
          // --- OPTIONS (Buttons) ---
          const container = document.createElement("div");
          container.className = "options-container";
          container.style.marginLeft = "16px";

          items.forEach(opt => {
              const btn = document.createElement("button");
              btn.className = "option-btn";
              btn.textContent = opt.label;
              btn.onclick = () => {
                  const input = document.getElementById("chat-text");
                  input.value = opt.value;
                  handleUserSend();
              };
              container.appendChild(btn);
          });
          body.appendChild(container);

      } else {
          // --- PRODUCT CARDS ---
          const container = document.createElement("div");
          container.style.marginBottom = "10px";
          container.style.marginLeft = "10px";

          items.forEach(p => {
              const card = document.createElement("div");
              card.className = "product-card";

              const price = parseFloat(p.price).toFixed(2);
              const imgSrc = p.image || "https://placehold.co/50x50?text=Img";

              // NEW: Select Button Logic
              const selectBtn = document.createElement("button");
              selectBtn.className = "product-select-btn";
              selectBtn.textContent = "Select";
              selectBtn.onclick = () => {
                  const input = document.getElementById("chat-text");
                  input.value = `I want to select ${p.name}`;
                  handleUserSend();
              };

              card.innerHTML = `
                  <img src="${imgSrc}" class="product-image" alt="${p.name}">
                  <div class="product-info">
                      <div class="product-name">${p.name}</div>
                      <div class="product-meta">
                          <span class="product-price">£${price}</span>
                      </div>
                  </div>
              `;
              // Append button safely
              card.querySelector(".product-meta").appendChild(selectBtn);

              container.appendChild(card);
          });

          if (items.length >= 3) {
             const moreBtn = document.createElement("button");
             moreBtn.className = "option-btn";
             moreBtn.style.marginTop = "8px";
             moreBtn.style.fontSize = "12px";
             moreBtn.textContent = "View More Products";
             moreBtn.onclick = () => {
                 const input = document.getElementById("chat-text");
                 input.value = "Show more";
                 handleUserSend();
             };
             container.appendChild(moreBtn);
          }

          body.appendChild(container);
      }
      scrollToBottom();
  }

  /* ================= UI HELPERS ================= */
  function streamResponse(prompt) {
      fetch(CHAT_STREAM_POST, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: prompt, session_id: SESSION_ID })
      }).catch(err => {
          console.error("Post Error:", err);
          showTyping(false);
          updateStatus("offline");
          toggleInputState(false);
      });
      requestStartTime = Date.now();
      showTyping(false);
      currentBotMessageDiv = appendMessage("", "bot");
  }

  function appendMessage(text, sender) {
      const body = document.getElementById("chat-body");
      const div = document.createElement("div");
      div.className = "message " + sender;
      const textNode = document.createElement("div");

      textNode._rawText = text;
      if (sender === "bot") {
          try { textNode.innerHTML = marked.parse(text); }
          catch(e) { textNode.textContent = text; }
      } else {
          textNode.textContent = text;
      }

      div.appendChild(textNode);
      const timeSpan = document.createElement("span");
      timeSpan.className = "msg-time";
      const now = new Date();
      timeSpan.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      div.appendChild(timeSpan);
      body.appendChild(div);
      scrollToBottom();
      return textNode;
  }

  function toggleInputState(disabled) {
      document.getElementById("chat-text").disabled = disabled;
      document.getElementById("send-btn").disabled = disabled;
      if (!disabled) document.getElementById("chat-text").focus();
  }
  
  function updateStatus(status) {
      const dot = document.getElementById("connection-status");
      const reconnectBtn = document.getElementById("reconnect-btn");
      dot.className = "status-dot " + status;
      if(status === 'offline') reconnectBtn.classList.remove("hidden");
      else reconnectBtn.classList.add("hidden");
  }

  function manualReconnect() {
      updateStatus("connecting");
      setupEventSource();
  }

  function checkConnection() {
      if (eventSource && eventSource.readyState === 1) return;
      fetch(HEALTH_API).then(res => updateStatus(res.ok ? "online" : "offline")).catch(() => updateStatus("offline"));
  }

  function toggleChat() {
      const chat = document.getElementById("frono-chat");
      const launcher = document.getElementById("frono-launcher");
      if (chat.classList.contains("hidden")) {
          chat.classList.remove("hidden");
          launcher.style.display = "none";
          setTimeout(() => document.getElementById("chat-text").focus(), 100);
      } else {
          chat.classList.add("hidden");
          launcher.style.display = "flex";
      }
  }

  function scrollToBottom() {
      const body = document.getElementById("chat-body");
      body.scrollTop = body.scrollHeight;
  }

  function showTyping(show) {
      const indicator = document.getElementById("typing-indicator");
      if (show) { indicator.classList.remove("hidden"); scrollToBottom(); }
      else { indicator.classList.add("hidden"); }
  }

  function handleUserSend() {
      const input = document.getElementById("chat-text");
      const text = input.value.trim();
      if (!text) return;
      toggleInputState(true);
      input.value = "";
      appendMessage(text, "user");
      showTyping(true);
      streamResponse(text);
  }

  document.getElementById("chat-text").addEventListener("keydown", function(e) {
      if (e.key === "Enter" && !this.disabled) handleUserSend();
  });
</script>

</body>
</html>
